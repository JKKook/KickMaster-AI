<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AI-FootBallAgent</title>
        <link rel="stylesheet" href="./stylesheets/main.css" />
    </head>
    <body>
        <div class="container">
            <div class="title">
                <em>ChatGpt AIì±—ë´‡ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”</em>
            </div>
            <div class="chat-box">
                <div class="chat-header">
                    <div class="chat-avatar">
                        <img
                            src="./assets/avatar2.png"
                            alt="profile"
                            class="avatar-img"
                        />
                    </div>
                    <div class="chat-info">
                        <h2 class="chat-name">Agent : CodrLee</h2>
                        <p class="chat-status">ì˜¨ë¼ì¸ &nbsp; ğŸŸ¢</p>
                    </div>
                </div>
                <div class="chat-body">
                    <div class="chat-message">
                        <p class="chat-mesage-intro">
                            ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ìœ í˜•ì˜ ì¶•êµ¬ì„ ìˆ˜ê°€ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?
                        </p>
                        <button class="modal-btn">Option ì„ íƒí•˜ê¸°</button>
                        <div class="modal">
                            <div class="modal-content">
                                <span class="close">&times;</span>
                                <h2>Option ì„ íƒ</h2>
                                <!-- select Box -->
                                <div
                                    class="select-box-container select-box-container-open"
                                >
                                    <div class="modal-background">
                                        <img
                                            src="./assets/manager.jpeg"
                                            alt="modal-background"
                                        />
                                    </div>
                                    <label for="yearOfBirth">ì—°ë„</label>
                                    <select id="yearOfBirth" name="yearOfBirth">
                                        <option value="">--ì„ íƒ ì—°ë„--</option>
                                        <!-- ìƒë…„ì›”ì¼ option ìƒì„± -->
                                    </select>

                                    <label for="league">ë¦¬ê·¸</label>
                                    <select id="league" name="league">
                                        <option value="">--ë¦¬ê·¸ ì„ íƒ--</option>
                                        <optgroup label="ë¦¬ê·¸">
                                            <option value="EPL">EPL</option>
                                            <option value="Laliga">
                                                Laliga
                                            </option>
                                            <option value="Bundesliga">
                                                Bundesliga
                                            </option>
                                            <option value="Serie A">
                                                Serie A
                                            </option>
                                            <option value="Ligue 1">
                                                Ligue 1
                                            </option>
                                            <option value="Eredivisie">
                                                Eredivisie
                                            </option>
                                        </optgroup>
                                    </select>

                                    <label for="position">í¬ì§€ì…˜</label>
                                    <select id="position" name="position">
                                        <option value="">
                                            --í¬ì§€ì…˜ ì„ íƒ--
                                        </option>
                                        <optgroup label="ê³µê²©ìˆ˜">
                                            <option value="FW">FW</option>
                                            <option value="ST">ST</option>
                                            <option value="CF">CF</option>
                                            <option value="LW">LW</option>
                                            <option value="RW">RW</option>
                                            <option value="SS">SS</option>
                                        </optgroup>
                                        <optgroup label="ë¯¸ë“œí•„ë”">
                                            <option value="MF">MF</option>
                                            <option value="CM">CM</option>
                                            <option value="DM">CDM</option>
                                            <option value="AM">CAM</option>
                                            <option value="LM">LM</option>
                                            <option value="RM">RM</option>
                                        </optgroup>
                                        <optgroup label="ìˆ˜ë¹„ìˆ˜">
                                            <option value="DF">DF</option>
                                            <option value="CB">CB</option>
                                            <option value="LB">LB</option>
                                            <option value="RB">RB</option>
                                            <option value="WB">LWB</option>
                                            <option value="WB">RWB</option>
                                        </optgroup>
                                        <optgroup label="ê³¨í‚¤í¼">
                                            <option value="GK">GK</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <button
                                    onclick="save()"
                                    class="select-save-btn"
                                >
                                    ì„ íƒ ì €ì¥
                                </button>
                            </div>
                        </div>

                        <!-- ë™ì  ë¼ìš°íŒ… -->

                        <div id="chat-log"></div>
                    </div>
                    <div id="loading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                </div>
                <div class="chat-footer">
                    <form class="input-form">
                        <input
                            type="text"
                            name="userInput"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            class="chat-input"
                        />
                        <button type="submit" class="chat-send">ë³´ë‚´ê¸°</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="kakao-adfit">
            <ins
                class="kakao_ad_area"
                style="display: none"
                data-ad-unit="DAN-58H2nPTliu9s9Nn9"
                data-ad-width="320"
                data-ad-height="100"
            ></ins>
            <script
                type="text/javascript"
                src="//t1.daumcdn.net/kas/static/ba.min.js"
                async
            ></script>
        </div>

        <script>
            const BUILD_SERVER =
                'https://dwwyyi3n4rqi2eah7qkqhty2rq0zfnvr.lambda-url.ap-northeast-2.on.aws/api/chat';
            // const SERVER_URL = 'http://localhost:7003/api/chat';

            const chatLog = document.getElementById('chat-log'); // ì±„íŒ… ê¸°ë¡ì´ í‘œì‹œë  div ì—˜ë¦¬ë¨¼íŠ¸
            const form = document.querySelector('.input-form'); // form ì—˜ë¦¬ë¨¼íŠ¸
            const chatInput = document.querySelector('.chat-input'); // ë©”ì‹œì§€ ì…ë ¥ ì°½ ì—˜ë¦¬ë¨¼íŠ¸

            // HISTORY : serverì— ë°°ì—´ í˜•íƒœë¡œ req.bodyì— ë°ì´í„° ì „ë‹¬
            let userMessages = [];
            let gptMessages = [];

            // string í˜•íƒœë¡œ requestì— ì „ë‹¬
            let selectOption = [];

            // select option save
            const save = () => {
                const optionBirth =
                    document.querySelector('#yearOfBirth').value;
                const optionLeague = document.querySelector('#league').value;
                const optionPosition =
                    document.querySelector('#position').value;

                let sumOption =
                    optionBirth +
                    '\u00a0' +
                    optionLeague +
                    '\u00a0' +
                    optionPosition +
                    '\u00a0';

                selectOption.push(sumOption);
                console.log(selectOption);

                if (selectOption) {
                    chatInput.value = `${sumOption}`;
                }
                modal.style.display = 'none';
            };

            // onClick ì´ë²¤íŠ¸ë¥¼ save í•¨ìˆ˜ í˜¸ì¶œë¡œ ì§€ì •
            document
                .querySelector('.select-save-btn')
                .addEventListener('click', () => {
                    // ìë™ì ìœ¼ë¡œ "ë³´ë‚´ê¸°" ë²„íŠ¼ì´ ëˆŒë ¤ì„œ request ë³´ë‚¼ ìˆ˜ ìˆë„ë¡
                    save();
                    handleSubmit();
                    // form.submit();
                });

            const handleSubmit = async () => {
                showLoading();
                // userInputê°’ ì±„íŒ… ë¡œê·¸ë¥¼ ì—…ë°ì´íŠ¸
                const userInput = chatInput.value; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’
                const userMessage = document.createElement('div');
                userMessage.classList.add('user-message');
                userMessage.innerHTML = `<p>${userInput}</p>`;
                chatLog.appendChild(userMessage);

                // ** Message history - user
                userMessages.push(userInput);

                // ë©”ì‹œì§€ ì…ë ¥ ì°½ì„ ì´ˆê¸°í™”
                chatInput.value = '';

                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì´ ì—†ìœ¼ë©´ ë” ì´ìƒ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                if (!userInput) {
                    return;
                }

                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ AI ì‘ë‹µì„ ê°€ì ¸ì˜´
                const response = await fetch(BUILD_SERVER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        // Message history ì „ë‹¬
                        selectOption, // selectOption req.body ì „ë‹¬
                        userMessages, // inputì°½
                        gptMessages, // outputì°½
                    }),
                });

                const responseData = await response.json();

                hideLoading();
                // ** response Message history - Gpt
                const chatGptOuput = responseData.output;
                gptMessages.push(chatGptOuput);

                // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì±„íŒ… ë¡œê·¸ë¥¼ ì—…ë°ì´íŠ¸í•¨
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message';
                botMessage.innerHTML = `
     <p>${chatGptOuput} </p>`;

                const linkText = document.createElement('p');
                linkText.classList.add('chat-pay-text');
                linkText.innerHTML = `\n ë§í¬ë¥¼ ëˆŒëŸ¬ì„œ í›„ì›ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ =>`;
                const link = document.createElement('a');
                link.classList.add('chat-pay-link');
                link.href = 'https://toss.me/codrlee';
                link.innerHTML = `ë§ˆìŒ í‘œí˜„í•˜ê¸°ğŸ§¡`;

                linkText.appendChild(link);
                botMessage.appendChild(linkText);

                chatLog.appendChild(botMessage);
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSubmit();
            });

            // select option
            const selectElement = document.querySelector('#yearOfBirth');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 2000; i -= 1) {
                const optionElement = document.createElement('option');
                optionElement.value = i;
                optionElement.textContent = i;
                selectElement.appendChild(optionElement);
            }

            // modal
            const modal = document.querySelector('.modal');
            const modalBtn = document.querySelector('.modal-btn');
            const closeContent = document.querySelector('.close');

            // When the user clicks the button, open the modal
            modalBtn.addEventListener('click', () => {
                modal.style.display = 'block';
                setTimeout(() => {
                    document.querySelector('.modal-content').style.transform =
                        'perspective(500px) rotateX(0deg) translateY(0)';
                }, 50);
            });

            closeContent.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // spinner
            const loading = document.querySelector('#loading');

            function showLoading() {
                loading.style.display = 'block';
            }

            function hideLoading() {
                loading.style.display = 'none';
            }
        </script>
        <script
            src="https://kit.fontawesome.com/ddf76d6ed0.js"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
